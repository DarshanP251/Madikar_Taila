<!DOCTYPE html>
<html>

<head>
  <meta charset="utf-8">
  <meta name="viewport" content="initial-scale=1, width=device-width">


  <link rel="stylesheet" href="../CSS/global.css" />
  <link rel="stylesheet" href="../CSS/home.css" />


  <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Hawthorne+Vintage:wght@400&display=swap" />
  <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500&display=swap" />
  <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;500;600;700&display=swap" />
  <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=SF+Pro+Display:wght@500&display=swap" />
  <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=SF+Pro+Text:wght@400&display=swap" />
</head>



</head>

<body>

  <div class="home">
    <div class="logo" data-scroll-to="lOGOContainer">
      <div class="logo1">
        <div class="madikar-taila">Madikar Taila</div>
        <img class="black-icon" alt="" src="../SRC/drop.svg">

      </div>
      <img class="background-icon" alt="" src="../SRC/background.svg">

      <div class="categorysection">
        <div class="cattitle">
          <div class="categories">Categories</div>
        </div>
        <div class="catitems">
          <div class="ellipse-parent">
            <img class="olive-oil-icon" id="groupContainerr" alt="" src="../SRC/Olive oil.png">
            <div class="group-child" id="groupContainer">
            </div>
            <div class="cooking-oil-wrapper">
              <div class="cooking-oil">
                <p class="cooking">Cooking </p>
                <p class="cooking">Oil</p>
              </div>
            </div>
          </div>
          <div class="ellipse-group">
            <img class="essential-oil-icon" id="groupContainer11" alt="" src="../SRC/Essential oil.png">
            <div class="group-child" id="groupContainer1">
            </div>
            <div class="essential-oil-wrapper">
              <div class="cooking-oil">
                <p class="cooking">Essential</p>
                <p class="cooking">Oil</p>
              </div>
            </div>
          </div>
          <div class="ellipse-container">
            <img class="coconut-oil-icon" id="groupContainer22" alt="" src="../SRC/Coconut oil.png">
            <div class="group-child" id="groupContainer2">
            </div>
            <div class="hair-oil-wrapper">
              <div class="cooking-oil">
                <p class="cooking">Hair </p>
                <p class="cooking">Oil</p>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
    <div class="cart-icon" id="cartIconContainer">
      <div class="cart-icon-child"></div>
      <img class="shopping-bag-icon" id="cartNavigate" alt="" src="../SRC/Shopping bag.png" />
    </div>
    <div class="profile-icon1" id="profileContainer">
      <div class="profile-child1"></div>
      <img class="prof-icon1" id="profileNavigate" alt="" src="../SRC/shopping-bag-icon1.png" />
    </div>
    <div class="offer-card">
      <img class="glass-bottle-with-olive-oil-gr-icon" alt=""
        src="../SRC/glass-bottle-with-olive-oil-gray-background 1.png">

      <div class="buttons" id="shopnowContainer">
        <div class="shop-now">Shop Now</div>
      </div>
      <div class="healthy-cooking">
        <p class="cooking">Healthy</p>
        <p class="cooking"> Cooking</p>
      </div>
    </div>


    <div class="our-featured-products">Our Featured Products</div>


    <!-- Products will render here -->
    <div class="product-grid"
      style="position: relative; top: 500px; left: 14px; width: 100%; display: flex; flex-direction: column;">
    </div>
  </div>


  <div class="cart-counter" id="cartCounter" style="position: absolute; top: 20px; right: 20px; background: #48cb66; color: white; 
            padding: 3px 8px; border-radius: 50%; display: none;">
  </div>









  <img class="social-icons" alt="" id="whatsappBtn" src="../SRC/WhatsApp-Logo-Icon.svg ">

  <div class="nav-bar">
    <div class="background">
    </div>
    <div class="buttons4" id="buttonsContainer01">
      <div class="medium3">Shop</div>
    </div>
    <div class="buttons5" id="buttonsContainer1">
      <div class="medium3">About</div>
    </div>
    <img class="magnifier-icon" alt="" src="../SRC/Magnifier.png" id="magnifierIcon">

    <div class="buttons6" id="buttonsContainer2">
      <div class="medium3">Home</div>
    </div>
  </div>
  </div>

  <div id="sampleContainer" class="popup-overlay" style="display: none">
    <div class="sample">
      <div class="input">
        <div class="label">Select Quantity</div>
        <div class="form">
          <div class="text-wrap">
            <div class="selected-option">Choose an option</div>
          </div>
          <img class="keyboard-arrow-up" alt="" src="../SRC/DownArrow.svg" />
        </div>
        <div class="drowdown-list"></div>
      </div>
    </div>
  </div>

  <div id="searchBarContainer" class="popup-overlay" style="display:none">

    <div class="searchbar">
      <div class="content">
        <div class="magnifyingglass">
          <div class="magnifyingglass1">􀊫</div>
        </div>
        <div class="placeholder-label">
          <span>|</span>
          <span class="search">Search</span>
        </div>
      </div>
    </div>


  </div>



  <script>
    let allProducts = [];
    let selectedProduct = null;
    let selectedQuantity = 1;
    let selectedSize = null;

    var cartIconContainer = document.getElementById("cartIconContainer");
    if (cartIconContainer) {
      cartIconContainer.addEventListener("click", function (e) {
        window.location.href = "../HTML/EmptyCart.html";
      });
    }

    var profileContainer = document.getElementById("profileContainer");
    if (profileContainer) {
      profileContainer.addEventListener("click", function (e) {
        window.location.href = "../HTML/profilepage.html";
      });
    }

    // Navigation event handlers
    var shopnowContainer = document.getElementById("shopnowContainer");
    if (shopnowContainer) {
      shopnowContainer.addEventListener("click", function (e) {
        window.location.href = "../HTML/Shopp1.html";
      });
    }

    var groupContainer = document.getElementById("groupContainer");
    if (groupContainer) {
      groupContainer.addEventListener("click", function (e) {
        window.location.href = "../HTML/CategoryCooking.html";
      });
    }

    var groupContainerr = document.getElementById("groupContainerr");
    if (groupContainerr) {
      groupContainerr.addEventListener("click", function (e) {
        window.location.href = "../HTML/CategoryCooking.html";
      });
    }

    var groupContainer1 = document.getElementById("groupContainer1");
    if (groupContainer1) {
      groupContainer1.addEventListener("click", function (e) {
        window.location.href = "../HTML/CategoryEssential.html";
      });
    }

    var groupContainer11 = document.getElementById("groupContainer11");
    if (groupContainer11) {
      groupContainer11.addEventListener("click", function (e) {
        window.location.href = "../HTML/CategoryEssential.html";
      });
    }

    var groupContainer22 = document.getElementById("groupContainer22");
    if (groupContainer22) {
      groupContainer22.addEventListener("click", function (e) {
        window.location.href = "../HTML/CategoryHairoil.html";
      });
    }

    var groupContainer2 = document.getElementById("groupContainer2");
    if (groupContainer2) {
      groupContainer2.addEventListener("click", function (e) {
        window.location.href = "../HTML/CategoryHairoil.html";
      });
    }

    // Fetch products from API
    async function fetchProducts() {
      try {
        const response = await fetch('http://localhost:5000/api/products');
        const data = await response.json();
        if (data.success) {
          allProducts = data.data;
          renderProducts(allProducts);
        } else {
          console.error('Failed to fetch products:', data.error);
          alert('Failed to load products. Please try again later.');
        }
      } catch (error) {
        console.error('Error fetching products:', error);
        alert('Network error loading products. Please check your connection.');
      }
    }

    // Render products to the page
    function renderProducts(products) {
      const productGrid = document.querySelector('.product-grid');
      if (!productGrid) return;
      productGrid.innerHTML = '';

      products.forEach((product) => {
        const defaultSize = product.sizes?.[0];
        const productCard = document.createElement('div');
        productCard.className = 'product-card';
        productCard.style = 'position: relative; box-shadow: 0 4px 4px rgba(0,0,0,0.25); width: 365px; height: 200px; margin-bottom: 5px;';

        productCard.innerHTML = ` 
          <img class="product-bg" src="../SRC/Rectangle 6.png" style="position:absolute;top:0;left:0;width:100%;height:100%;border-radius:15px;">
          <div class="item-description" style="position:absolute;top:32px;right:5px;font-size:12px;line-height:150%;font-weight:600;width:185px;height:72px;overflow: hidden;display: -webkit-box;-webkit-line-clamp: 2;-webkit-box-orient: vertical;text-overflow: ellipsis;">${product.description}</div>
          <div class="product-info" style="position:absolute;top:7px;left:176px;width:185px;height:25px;">
            <b class="product-name" style="line-height:150%;width:119.2px;height:25px;font-size:15px;">${product.name}</b>
            <b class="price" style="position:absolute;top:0;left:145.28px;line-height:150%;width:39.7px;height:25px;font-size:15px;" id="productPrice_${product._id}">${defaultSize?.price || 0}/-</b>
          </div>
          <img class="product-image" src="${product.image}" style="position:absolute;top:7px;left:13px;border-radius:10px;width:155px;height:185px;object-fit:cover;cursor:pointer;" onclick="viewProduct('${product._id}')">
          <div class="quantity-select" style="position:absolute;top:129px;left:204px;border-radius:12px;background-color:#f0f0f0;width:120px;height:30px;display:flex;align-items:center;justify-content:center;cursor:pointer;" onclick="selectQuantity('${product._id}')">
            <div class="small" id="quantitySelect_${product._id}" style="font-size:12px;color:#555;">${defaultSize ? `${defaultSize.size} - ₹${defaultSize.price}` : 'Select Quantity'}</div>
          </div>
          <div class="add-to-cart" style="position:absolute;top:159px;left:204px;border-radius:12px;background-color:#48cb66;width:120px;height:30px;display:flex;align-items:center;justify-content:center;color:white;cursor:pointer;" onclick="addToCart('${product._id}')">
            <div class="small" style="font-size:12px;">Add to cart</div>
          </div>
        `;

        productGrid.appendChild(productCard);
      });
    }

    // View product details
    function viewProduct(productId) {
      window.location.href = `../public/ProductDynamic.html?id=${productId}`;
    }

    // Select quantity popup
    function selectQuantity(productId) {
      const popup = document.getElementById("sampleContainer");
      if (!popup) return;

      selectedProduct = allProducts.find(product => product._id === productId);
      if (!selectedProduct) return;

      // Initialize with first size if none selected
      if (!selectedSize || selectedProduct._id !== (selectedProduct && selectedProduct._id)) {
        selectedSize = selectedProduct.sizes?.[0];
      }

      popup.style.display = "flex";
      popup.style.zIndex = 1000;
      popup.style.backgroundColor = "rgba(113,113,113,0.3)";
      popup.style.alignItems = "center";
      popup.style.justifyContent = "center";
      popup.setAttribute("closable", "");

      const clickHandler = (e) => {
        if (e.target === popup && popup.hasAttribute("closable")) {
          popup.style.display = "none";
          popup.removeEventListener("click", clickHandler);
        }
      };
      popup.addEventListener("click", clickHandler);

      updateQuantityPopup();
    }

    // Update quantity popup options
    function updateQuantityPopup() {
      const quantityList = document.querySelector('.drowdown-list');
      if (!quantityList || !selectedProduct) return;
      quantityList.innerHTML = '';

      if (!selectedProduct.sizes || selectedProduct.sizes.length === 0) {
        quantityList.innerHTML = '<div class="dropdown-item">No sizes available</div>';
        return;
      }

      selectedProduct.sizes.forEach(size => {
        const item = document.createElement('div');
        item.classList.add('dropdown-item');
        item.textContent = `${size.size} - ₹${size.price}`;

        if (selectedSize && size.size === selectedSize.size && size.price === selectedSize.price) {
          item.style.backgroundColor = '#e0f7fa';
          item.style.fontWeight = 'bold';
        }

        item.onclick = () => selectSizeAndPrice(size);
        quantityList.appendChild(item);
      });
    }

    // Handle size selection
    function selectSizeAndPrice(size) {
      selectedSize = size;
      selectedQuantity = 1;

      // Update price display
      const priceElement = document.querySelector(`#productPrice_${selectedProduct._id}`);
      if (priceElement) {
        priceElement.textContent = `${selectedSize.price}/-`;
      }

      // Update the quantity selector text
      const quantitySelector = document.querySelector(`#quantitySelect_${selectedProduct._id}`);
      if (quantitySelector) {
        quantitySelector.textContent = `${selectedSize.size} - ₹${selectedSize.price}`;
      }

      const popup = document.getElementById("sampleContainer");
      if (popup) popup.style.display = "none";
    }

    // Add to cart function
    async function addToCart(productId) {
      const token = localStorage.getItem("authToken");

      if (!token) {
        alert("Please login first!");
        window.location.href = "../HTML/login.html";
        return;
      }

      // Get the currently selected size for this product
      const quantitySelector = document.querySelector(`#quantitySelect_${productId}`);
      if (!quantitySelector || !quantitySelector.textContent.includes('-')) {
        alert("Please select a size first!");
        return;
      }

      try {
        // Find the product and selected size
        const product = allProducts.find(p => p._id === productId);
        if (!product) throw new Error("Product not found");

        const sizeText = quantitySelector.textContent.split(' - ')[0];
        const size = product.sizes.find(s => s.size === sizeText);
        if (!size) throw new Error("Selected size not found");

        const response = await fetch("http://localhost:5000/api/cart/add", {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
            "Authorization": `Bearer ${token}`
          },
          body: JSON.stringify({
            productId,
            sizeId: size._id,
            quantity: 1,
            price: size.price
          })
        });

        const responseData = await response.json();

        if (!response.ok) {
          throw new Error(responseData.error || "Failed to add to cart");
        }

        alert("Product added to cart!");
        updateCartCounter();
      } catch (error) {
        console.error("Add to cart error:", error);
        alert(error.message);
      }
    }

    // Update cart counter
    async function updateCartCounter() {
      const token = localStorage.getItem("authToken");
      const cartCounter = document.getElementById("cartCounter");

      if (!token) {
        cartCounter.style.display = "none";
        return;
      }

      try {
        const response = await fetch("http://localhost:5000/api/cart", {
          headers: {
            "Authorization": `Bearer ${token}`
          }
        });

        if (!response.ok) throw new Error("Failed to fetch cart");

        const cartData = await response.json();
        const totalItems = cartData.items.reduce((sum, item) => sum + item.quantity, 0);

        cartCounter.textContent = totalItems;
        cartCounter.style.display = totalItems > 0 ? "block" : "none";
      } catch (error) {
        console.error("Cart counter update failed:", error);
        cartCounter.style.display = "none";
      }
    }

    // WhatsApp button handler
    const whatsappURL = 'https://wa.me/+919538730511?text=Hello%20there!';
    document.getElementById('whatsappBtn').addEventListener('click', function () {
      window.location.href = whatsappURL;
    });

    // Navigation handlers
    const aboutBtn = document.getElementById("buttonsContainer1");
    if (aboutBtn) {
      aboutBtn.addEventListener("click", function () {
        window.location.href = "../HTML/AboutUs.html";
      });
    }

    const shopBtn = document.getElementById("buttonsContainer01");
    if (shopBtn) {
      shopBtn.addEventListener("click", function () {
        window.location.href = "../HTML/Shopp1.html";
      });
    }

    const homeBtn = document.getElementById("buttonsContainer2");
    if (homeBtn) {
      homeBtn.addEventListener("click", function () {
        window.location.href = "../HTML/home1.html";
      });
    }

    // Search functionality
    var magnifierIcon = document.getElementById("magnifierIcon");
    if (magnifierIcon) {
      magnifierIcon.addEventListener("click", function () {
        var popup = document.getElementById("searchBarContainer");
        if (!popup) return;

        popup.style.display = "flex";
        popup.style.zIndex = 100;
        popup.style.backgroundColor = "rgba(113, 113, 113, 0.3)";
        popup.style.alignItems = "center";
        popup.style.justifyContent = "center";
        popup.setAttribute("closable", "");

        popup.addEventListener("click", function (e) {
          if (e.target === popup && popup.hasAttribute("closable")) {
            popup.style.display = "none";
          }
        });
      });
    }

    // Initialize on page load
    document.addEventListener('DOMContentLoaded', () => {
      fetchProducts();
      updateCartCounter();
    });
  </script>
</body>

</html>